<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        :root {
            --fade-duration: 500ms;
            --track-title: "";
            --background: rgba(0, 0, 0, 0.55);
            --padding: 0.5em 1em;
        }

        body {
            margin: 0;
            background: transparent;
            font-family: Roboto;
        }

        @keyframes glitch1 {
            0% {
                clip: rect(64px, 9999px, 94px, 0);
            }

            10% {
                clip: rect(87px, 9999px, 27px, 0);
            }

            20% {
                clip: rect(53px, 9999px, 82px, 0);
            }

            30% {
                clip: rect(25px, 9999px, 68px, 0);
            }

            40% {
                clip: rect(41px, 9999px, 26px, 0);
            }

            50% {
                clip: rect(6px, 9999px, 78px, 0);
            }

            60% {
                clip: rect(9px, 9999px, 70px, 0);
            }

            70% {
                clip: rect(1px, 9999px, 46px, 0);
            }

            80% {
                clip: rect(83px, 9999px, 64px, 0);
            }

            90% {
                clip: rect(23px, 9999px, 76px, 0);
            }

            100% {
                clip: rect(59px, 9999px, 49px, 0);
            }
        }

        @keyframes glitch2 {
            0% {
                clip: rect(71px, 9999px, 85px, 0);
            }

            10% {
                clip: rect(19px, 9999px, 8px, 0);
            }

            20% {
                clip: rect(74px, 9999px, 66px, 0);
            }

            30% {
                clip: rect(30px, 9999px, 91px, 0);
            }

            40% {
                clip: rect(37px, 9999px, 27px, 0);
            }

            50% {
                clip: rect(86px, 9999px, 19px, 0);
            }

            60% {
                clip: rect(62px, 9999px, 54px, 0);
            }

            70% {
                clip: rect(96px, 9999px, 71px, 0);
            }

            80% {
                clip: rect(14px, 9999px, 29px, 0);
            }

            90% {
                clip: rect(32px, 9999px, 7px, 0);
            }

            100% {
                clip: rect(46px, 9999px, 92px, 0);
            }
        }

        #wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #wrapper,
        #track {
            position: relative;
        }

        #track,
        #track::before,
        #track::after {
            padding: var(--padding);
        }

        #track {
            font-size: 2rem;
            background: var(--background);
            border-radius: 4px;
            color: white;
            opacity: 1;
            transition: opacity var(--fade-duration) ease;
            will-change: opacity;
            text-transform: lowercase;
        }

        #track::before,
        #track::after {
            content: var(--track-title);
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
        }

        #track::before {
            left: 1px;
            text-shadow: -1px 0 rgba(26, 26, 26, 0.85);
            animation: glitch1 1.3s linear alternate-reverse infinite;
        }

        #track::after {
            left: -1px;
            text-shadow: -1px 0 rgba(26, 26, 26, 0.85);
            animation: glitch2 1s ease-out alternate-reverse infinite;
        }

        #track.hidden {
            opacity: 0;
        }

        .empty {
            display: none;
        }
    </style>
</head>

<body>

    <div id="wrapper">
        <div id="track" class="empty"></div>
    </div>

    <script>
        // CONFIGURATION
        const DISPLAY_PREFIX = "now playing:"
        const FETCH_INTERVAL = 1000;
        const ENABLE_GLITCH_EFFECT = true;
        const CSS_TRANSITION_TIME = getCssTransitionTime();

        let currentTrack = "";

        async function fetchTrack() {
            try {
                const url = `http://localhost:3000/now-playing`
                const response = await fetch(url);
                const data = await response.json();
                return data
            } catch (e) {
                console.error(e);
                return "";
            }
        }

        function getCssTransitionTime() {
            const fadeDurationStr = getComputedStyle(document.documentElement)
                .getPropertyValue('--fade-duration')
                .trim();

            const fadeDuration = parseFloat(fadeDurationStr);
            return fadeDuration;
        }

        async function updateTrack() {
            const { track } = await fetchTrack();
            const hasTrack = track.artist && track.title;
            const newTrack = hasTrack ? `${track.artist} - ${track.title}` : ""

            const el = document.getElementById("track");

            // if there is no track, completely hide the UI
            // otherwise space from padding is visible w/ no text
            if (!hasTrack) {
                el.classList.add("empty");
                el.textContent = "";
                el.style.setProperty("--track-title", `""`);
                currentTrack = "";
                return;
            }

            // if the track hasn't changed, do nothing
            if (newTrack === currentTrack) {
                return;
            }

            // if we are showing a track, make sure the empty class is removed
            el.classList.remove("empty");

            el.classList.add("hidden");

            // wait for fade-out to finish
            setTimeout(() => {
                const updatedText = `${DISPLAY_PREFIX} ${newTrack}`;

                if (ENABLE_GLITCH_EFFECT) {
                    // update the --track-title CSS variable for the glitch effect to work
                    el.style.setProperty("--track-title", `"${updatedText}"`);
                }

                el.textContent = newTrack
                    ? updatedText
                    : "";

                currentTrack = newTrack;

                el.classList.remove("hidden");
            }, CSS_TRANSITION_TIME);
        }

        updateTrack();

        setInterval(updateTrack, FETCH_INTERVAL);
    </script>

</body>

</html>